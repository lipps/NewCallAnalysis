#!/usr/bin/env python3
"""æµ‹è¯•å®é™…é”€å”®å¯¹è¯ä¸­çš„è¦é’±è¡Œä¸ºæ£€æµ‹"""

import asyncio
import sys
import os
import re

# æ·»åŠ é¡¹ç›®æ ¹ç›®å½•åˆ°è·¯å¾„
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

from src.processors.process_processor import ProcessProcessor
from src.processors.text_processor import TextProcessor

async def test_real_sales_conversation():
    """æµ‹è¯•å®é™…é”€å”®å¯¹è¯ä¸­çš„è¦é’±è¡Œä¸ºæ£€æµ‹"""
    
    print("ğŸ§ª æµ‹è¯•å®é™…é”€å”®å¯¹è¯ - è¦é’±è¡Œä¸ºæ£€æµ‹")
    print("=" * 60)
    
    # å®é™…çš„é”€å”®å¯¹è¯æ•°æ®
    real_sales_text = """ä¾¯èŒœèŒœ 2025å¹´09æœˆ07æ—¥ 16:48:21
æ‚¨å¥½æ‚¨å¥½ï¼Œè¯·é—®æ˜¯å°¾å·æ˜¯744çš„æœºä¸»æœ¬äººå—ï¼Ÿ

å®¢æˆ· 2025å¹´09æœˆ07æ—¥ 16:48:25
ä½ è¯´ã€‚

ä¾¯èŒœèŒœ 2025å¹´09æœˆ07æ—¥ 16:48:26
è¿™è¾¹çœ‹æ‚¨åœ¨8æœˆ7å·æœ‰ä¸‹è½½æ³¨å†Œäº†å’±ä»¬ç›Šç›Ÿæ“ç›˜æ‰‹è‚¡ç¥¨åˆ†æè½¯ä»¶ï¼Œå¾ˆå¤šåŒæœŸä¸‹è½½çš„ç”¨æˆ·åé¦ˆè½¯ä»¶åŠŸèƒ½ä¸å¤ªä¼šç”¨ï¼Œã€‚

ä¾¯èŒœèŒœ 2025å¹´09æœˆ07æ—¥ 16:48:37
æ‰€ä»¥å…¬å¸ç‰¹åœ°å®‰æ’æˆ‘ç»™ä½ æ¥ç”µï¼Œä¸“é—¨å…è´¹æ•™æ‚¨ä½¿ç”¨çš„ï¼Œå¦‚æœæ‚¨ç”¨ä¸‹æ¥è§‰å¾—å¥½ï¼ŒåæœŸé•¿æœŸå…è´¹å»ç”¨å°±å¯ä»¥äº†ï¼Œæ‚¨è¿™è¾¹ç”¨çš„æ˜¯æ‰‹æœºç‰ˆè¿˜æ˜¯ç”µè„‘ç‰ˆå‘¢ã€‚

ä¾¯èŒœèŒœ 2025å¹´09æœˆ07æ—¥ 16:49:15
å”‰ç„¶åè¿”å›åˆ°æ‰‹æœºæ¡Œé¢æ‰“å¼€è½¯ä»¶ï¼Œæ¥ç›Šç›Ÿæ“ç›˜æ‰‹è‚¡ç¥¨åˆ†æè½¯ä»¶ï¼Œæ‰“å¼€ä¹‹åå‘¢ç‚¹å‡»å·¦ä¸Šè§’çš„é‚£ä¸ªå°äººå¤´åƒï¼Œç„¶åå†çœ‹ä¸€ä¸‹å¤´åƒä¸‹æ–¹æ˜¯æ‚¨çš„å°¾å·47æ˜¯æ˜¯çš„å°¾å·ç™»å½•çš„å—ï¼Ÿ

ä¾¯èŒœèŒœ 2025å¹´09æœˆ07æ—¥ 16:51:01
åªèƒ½ç”¨ä¸‰ä¸ªè‚¡ç¥¨æ˜¯å§ï¼Ÿ

ä¾¯èŒœèŒœ 2025å¹´09æœˆ07æ—¥ 17:06:16
å•Šè¿™ä¸ªåŠŸèƒ½æˆ‘è·Ÿä½ è®²å®ƒæ˜¯å’±ä»¬ç›Šç›Ÿ23å¹´çš„æ ¸å¿ƒç»å…¸åŠŸèƒ½ï¼Œè¿™ä¸ªåŠŸèƒ½å‘¢åœ¨å¤–é¢å…¶ä»–ä»»ä½•ä¸€å®¶å…¬å¸çš„è‚¡ç¥¨åˆ†æè½¯ä»¶é‡Œé¢éƒ½æ‰¾ä¸åˆ°è·Ÿå’±ä»¬ç±»ä¼¼ä¸€æ ·çš„åŠŸèƒ½ï¼Œå‘€æˆ‘è¿™è¾¹è¯¦ç»†æ•™æ‚¨ä¸€ä¸‹ï¼Œæ‚¨è®¤çœŸçœ‹ä¸€ä¸‹è¿™ä¸ªåŠŸèƒ½å‘¢è¿™ä¸Šé¢æœ‰ä¸€ä¸ªã€‚

ä¾¯èŒœèŒœ 2025å¹´09æœˆ07æ—¥ 17:29:48
å…¨æ˜¯æ”¶è´¹å—¯288ã€‚

ä¾¯èŒœèŒœ 2025å¹´09æœˆ07æ—¥ 17:29:54
288æ‚¨ç¡®å®šï¼Œå•Šå› ä¸ºåƒå’±ä»¬è¿™ä¸ªè½¯ä»¶çš„è¯ï¼ŒåŸä»·æ˜¯1680ä¸€å¹´çš„ï¼Œç›¸å½“äºç›¸å½“äºæƒ³æŠ¢å™¢

ä¾¯èŒœèŒœ 2025å¹´09æœˆ07æ—¥ 17:30:13
å™¢é‚£ç›¸å½“äºä½ æŠ¢åˆ°äº†å’±ä»¬ç°å®ç§’æ€çš„ä¸€ä¸ªæ´»åŠ¨ï¼Œå‘€æ­å–œä½ å•Šå“¥ï¼Œä½ æƒ³äºŒç™¾å…«äºŒç™¾å…«åå…«ä¸€å¹´çš„æ—¶é—´ï¼Œç›¸å½“äºä¸€å¤©å¹³å‡ç®—ä¸‹æ¥ä¸åˆ°å‡ æ¯›é’±ï¼Œå•Šæ‚¨ç°åœ¨çš„

ä¾¯èŒœèŒœ 2025å¹´09æœˆ07æ—¥ 17:30:34
å•Šå°±æ˜¯è¯´å•Šè¿™ä¸ªå·¥å·å•Šä½ ä¸€å®šè¦å¡«ï¼Œä¸ºä»€ä¹ˆï¼Ÿå‘¢æ‚¨çœ‹æˆ‘ä»Šå¤©ä¹ŸèŠ±äº†è¿™ä¹ˆé•¿çš„æ—¶é—´å»æ•™ä½ ï¼Œå•Šåƒå’±ä»¬è¿™æ˜¯ç‰ˆè½¯ä»¶é‡Œé¢è¿˜æœ‰å…¶ä»–å¥½ç”¨é‚£äº›åŠŸèƒ½ï¼Œå‘€åç»­å’±ä»¬å¼€é€šä¹‹åå‘¢éƒ½æ˜¯æ¿ã€‚

ä¾¯èŒœèŒœ 2025å¹´09æœˆ07æ—¥ 17:31:48
å”‰å¤§å“¥æ‚¨æ”¾å¿ƒå¥½äº†ï¼Œå’±ä»¬è¿™ä¸ªè½¯ä»¶å‘¢å®ƒå°±æ˜¯åŒ…æ‹¬æˆ‘ä»¬è½¦ç•¥é¢„é€‰æ—¶ä»¥åŠå’±ä»¬5000å¤šå®¶çš„ä¸ªè‚¡ä¹°å–ç‚¹éƒ½æ˜¯åŒ…å«åœ¨å†…çš„ã€‚

ä¾¯èŒœèŒœ 2025å¹´09æœˆ07æ—¥ 17:31:58
è€Œä¸”ä½ ä»Šå¤©å¼€é€šåŠå¹´ä¹‹åï¼Œå’±ä»¬ä¹Ÿæ˜¯ç›¸å½“äºæœ‰ç¼˜åˆ†ï¼Œå˜›æˆ‘å†ç»™ç»™æ‚¨é€ä¸€å¥—å’±ä»¬ç›Šç›Ÿå°±æ˜¯æ“ç›˜æ‰‹ç¬¬ä¸€è¯¾ï¼Œè¿™ä¸ªè¯¾ç¨‹å‘¢å°±æ˜¯ä¸“é—¨ä½ åœ¨å¤–é¢å»å¬çš„è¯ä¹Ÿæ˜¯è¦èŠ±å‡ åƒå—é’±çš„ã€‚

ä¾¯èŒœèŒœ 2025å¹´09æœˆ07æ—¥ 17:32:21
è®²å’±ä»¬ä¸€äº›é€‰è‚¡å•Šä»¥åŠä¹°å–çš„ä¸€äº›å¥½çš„æ–¹æ³•ï¼Œå…¶å®æ‚¨åŠç†ä¹‹åï¼Œå‘¢æˆ‘è¿™è¾¹ç‰¹å½»åº•å»ç»™æ‚¨ç”³è¯·ä¸‹æ¥ï¼Œç›´æ’­å›æ”¾çš„è¯éƒ½æ˜¯æœ‰çš„ï¼Œæ‚¨ç‚¹è¿›å»æ“ä½œåŠç†ä¸€ä¸‹ã€‚

ä¾¯èŒœèŒœ 2025å¹´09æœˆ07æ—¥ 17:32:36
è€Œä¸”çš„è¯åˆ°æ—¶å€™æˆ‘è¿˜ä¼šå†å†ç»™æ‚¨å’±ä»¬é€ä¸‰ä¸ªæœˆçš„ä¸€ä¸ªä½¿ç”¨æœŸï¼Œå˜›

ä¾¯èŒœèŒœ 2025å¹´09æœˆ07æ—¥ 17:32:54
å’±ä»¬å…¬å¸çš„è¯å·²ç»æœ‰23å¹´çš„ä¸€ä¸ªæ—¶é—´äº†ï¼Œåœ¨å›½å†…è‚¡ç¥¨æ”¶è´¹æ’åçš„è¯ä¹Ÿæ˜¯ç¬¬ä¸€çš„ï¼Œå’±ä»¬ç”¨æˆ·è¿ç»­è´¹ç‡å‘¢ä¹Ÿæ˜¯å åˆ°80%ã€‚

ä¾¯èŒœèŒœ 2025å¹´09æœˆ07æ—¥ 17:33:30
é‚£åŒæ ·å‘¢å’±ä»¬ä»Šå¹´çœŸæ­£çš„å»èŠ±288å»å¼€é€šä¸€å¹´ï¼Œå’±ä»¬çœŸæ­£çš„å»ç”¨ä¸€ç‚¹ï¼Œå¦‚æœè¯´å’±ä»¬åœ¨ç”¨çš„è¿‡ç¨‹å½“ä¸­ï¼Œä½ è§‰å¾—å’±ä»¬è½¯ä»¶å¯¹ä½ æ¥è¯´å¸®åŠ©å¸®åŠ©ä¸æ–­çš„è¯ï¼Œä½ æƒ³ä¸€ä¸‹ï¼Œæ‚¨ç¬¬ä¸€ç‚¹ç”¨çš„ä¸å¥½ï¼Œç¬¬ï¼Œç¬¬äºŒå¹´è¿˜ä¼šèŠ±é’±å»ç”¨å—ï¼Œé‚£è‚¯å®šä¹Ÿä¸å¯èƒ½å†ç”¨çš„å¯¹ä¸å¯¹ï¼Ÿ

ä¾¯èŒœèŒœ 2025å¹´09æœˆ07æ—¥ 17:33:59
è¿™ä¸ªè¯å°±è€½è¯¯æ‚¨å‡ åˆ†é’Ÿçš„æ—¶é—´å°±å¯ä»¥äº†ï¼Œæ‚¨ç‚¹è¿›å»æ“ä½œåŠç†ä¸€ä¸‹ã€‚"""

    # æå–é”€å”®è¯è¯­
    sales_utterances = extract_sales_utterances(real_sales_text)
    
    print(f"ğŸ“‹ æå–äº† {len(sales_utterances)} æ¡é”€å”®è¯è¯­")
    print("-" * 40)
    
    processor = ProcessProcessor()
    text_processor = TextProcessor()
    
    # åˆ†ææ¯æ¡é”€å”®è¯è¯­çš„è¯¦ç»†æ£€æµ‹è¿‡ç¨‹
    print("ğŸ” è¯¦ç»†æ£€æµ‹è¿‡ç¨‹åˆ†æï¼š")
    print("-" * 50)
    
    total_money_asks = 0
    all_quotes = []
    
    for i, utterance in enumerate(sales_utterances, 1):
        print(f"\n{i}. è¯è¯­: {utterance}")
        
        # æµ‹è¯•å•æ¡è¯è¯­
        single_test = {
            'content_analysis': {
                'sales_content': [utterance]
            }
        }
        
        single_result = processor._detect_money_ask(single_test)
        is_money_ask = single_result['count'] > 0
        
        # è¯¦ç»†åˆ†æè¿™æ¡è¯è¯­
        print(f"   æ£€æµ‹ç»“æœ: {'âœ… è¦é’±è¡Œä¸º' if is_money_ask else 'âŒ éè¦é’±è¡Œä¸º'}")
        
        # æ‰‹åŠ¨æ£€æŸ¥æ˜¯å¦åŒ…å«å…³é”®è¯
        money_keywords = ['288', '1680', 'æ”¶è´¹', 'å¼€é€š', 'åŠç†', 'èŠ±', 'é’±', 'å…ƒ', 'å…è´¹', 'ä»˜è´¹', 'ä¼šå‘˜', 'VIP']
        found_keywords = [kw for kw in money_keywords if kw in utterance]
        if found_keywords:
            print(f"   åŒ…å«å…³é”®è¯: {found_keywords}")
        
        # æµ‹è¯•æˆ‘ä»¬çš„æ£€æµ‹å‡½æ•°
        contains_behavior = processor._contains_money_ask_behavior(utterance)
        print(f"   _contains_money_ask_behavior: {contains_behavior}")
        
        if is_money_ask:
            total_money_asks += 1
            if single_result['quotes']:
                all_quotes.extend(single_result['quotes'])
                print(f"   è¯æ®: {single_result['quotes'][0]}")
    
    # æ€»ä½“æ£€æµ‹ç»“æœ
    print(f"\nğŸ“Š æ€»ä½“æ£€æµ‹ç»“æœ:")
    print(f"æ£€æµ‹åˆ°è¦é’±è¡Œä¸º: {total_money_asks} æ¬¡")
    
    if all_quotes:
        print("\nğŸ“‹ æ‰€æœ‰è¯æ®ç‰‡æ®µ:")
        for i, quote in enumerate(all_quotes, 1):
            print(f"{i}. {quote}")
    
    # æ‰‹åŠ¨æ ‡æ³¨çš„çœŸå®è¦é’±è¡Œä¸º
    print(f"\nğŸ¯ é¢„æœŸè¦é’±è¡Œä¸º (åº”è¯¥æ£€æµ‹åˆ°çš„):")
    expected_money_asks = [
        "å…¨æ˜¯æ”¶è´¹å—¯288",
        "288æ‚¨ç¡®å®šï¼Œå•Šå› ä¸ºåƒå’±ä»¬è¿™ä¸ªè½¯ä»¶çš„è¯ï¼ŒåŸä»·æ˜¯1680ä¸€å¹´çš„",
        "å™¢é‚£ç›¸å½“äºä½ æŠ¢åˆ°äº†å’±ä»¬ç°å®ç§’æ€çš„ä¸€ä¸ªæ´»åŠ¨ï¼Œå‘€æ­å–œä½ å•Šå“¥ï¼Œä½ æƒ³äºŒç™¾å…«äºŒç™¾å…«åå…«ä¸€å¹´çš„æ—¶é—´",
        "åç»­å’±ä»¬å¼€é€šä¹‹åå‘¢éƒ½æ˜¯æ¿",
        "è€Œä¸”ä½ ä»Šå¤©å¼€é€šåŠå¹´ä¹‹å",
        "æ‚¨ç‚¹è¿›å»æ“ä½œåŠç†ä¸€ä¸‹",
        "é‚£åŒæ ·å‘¢å’±ä»¬ä»Šå¹´çœŸæ­£çš„å»èŠ±288å»å¼€é€šä¸€å¹´",
        "è¿™ä¸ªè¯å°±è€½è¯¯æ‚¨å‡ åˆ†é’Ÿçš„æ—¶é—´å°±å¯ä»¥äº†ï¼Œæ‚¨ç‚¹è¿›å»æ“ä½œåŠç†ä¸€ä¸‹"
    ]
    
    for expected in expected_money_asks:
        print(f"- {expected[:80]}{'...' if len(expected) > 80 else ''}")
    
    # æ€§èƒ½åˆ†æ
    expected_count = len(expected_money_asks)
    print(f"\nğŸ“ˆ æ£€æµ‹æ•ˆæœåˆ†æï¼š")
    print(f"å®é™…æ£€æµ‹åˆ°: {total_money_asks} æ¬¡")
    print(f"é¢„æœŸåº”æ£€æµ‹: {expected_count} æ¬¡")
    
    if total_money_asks > 0:
        # ä¼°ç®—å‡†ç¡®ç‡ï¼ˆè¿™é‡Œç®€åŒ–å¤„ç†ï¼‰
        precision_estimate = min(total_money_asks, expected_count) / total_money_asks
        recall_estimate = min(total_money_asks, expected_count) / expected_count
        print(f"ä¼°è®¡ç²¾ç¡®ç‡: {precision_estimate:.1%}")
        print(f"ä¼°è®¡å¬å›ç‡: {recall_estimate:.1%}")
    else:
        print("âŒ å¬å›ç‡: 0% (æœªæ£€æµ‹åˆ°ä»»ä½•è¦é’±è¡Œä¸º)")
        print("ğŸ”§ éœ€è¦è°ƒæ•´æ£€æµ‹é€»è¾‘")

def extract_sales_utterances(conversation_text):
    """ä»å¯¹è¯æ–‡æœ¬ä¸­æå–é”€å”®äººå‘˜çš„è¯è¯­"""
    
    sales_utterances = []
    lines = conversation_text.split('\n')
    
    print(f"ğŸ” è§£æå¯¹è¯æ–‡æœ¬ï¼Œå…± {len(lines)} è¡Œ")
    
    i = 0
    while i < len(lines):
        line = lines[i].strip()
        if not line:
            i += 1
            continue
            
        print(f"ç¬¬{i+1}è¡Œ: {line[:50]}...")
        
        # æ£€æŸ¥æ˜¯å¦æ˜¯é”€å”®äººå‘˜è¯´è¯ï¼ˆä¾¯èŒœèŒœï¼‰
        if line.startswith('ä¾¯èŒœèŒœ'):
            print(f"  -> å‘ç°é”€å”®è¯è¯­æ ‡è¯†")
            
            # ä¸‹ä¸€è¡Œåº”è¯¥æ˜¯å®é™…å†…å®¹
            if i + 1 < len(lines):
                content = lines[i + 1].strip()
                if content and len(content) > 8:
                    sales_utterances.append(content)
                    print(f"  -> æ·»åŠ è¯è¯­: {content[:50]}...")
                else:
                    print(f"  -> ä¸‹ä¸€è¡Œå†…å®¹ä¸ºç©ºæˆ–å¤ªçŸ­: '{content}'")
            else:
                print(f"  -> æ²¡æœ‰ä¸‹ä¸€è¡Œå†…å®¹")
            
            i += 2  # è·³è¿‡æ—¶é—´æˆ³è¡Œå’Œå†…å®¹è¡Œ
        elif line.startswith('å®¢æˆ·'):
            print(f"  -> å®¢æˆ·è¯è¯­ï¼Œè·³è¿‡")
            i += 2  # è·³è¿‡å®¢æˆ·çš„æ—¶é—´æˆ³å’Œå†…å®¹
        else:
            print(f"  -> å…¶ä»–å†…å®¹ï¼Œè·³è¿‡")
            i += 1
    
    print(f"ğŸ“‹ æœ€ç»ˆæå–åˆ° {len(sales_utterances)} æ¡é”€å”®è¯è¯­")
    return sales_utterances

if __name__ == "__main__":
    asyncio.run(test_real_sales_conversation()) 